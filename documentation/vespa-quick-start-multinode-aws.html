---
# Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.
title: "Multi-Node Quick Start: Install and run Vespa on AWS EC2"
---

<p>Requirements:
<ul>
  <li>An AWS account </li>
  <li>
Readers are expected to be familiar with <a
 href="vespa-quick-start-centos.html">setting up a single-node system</a>.
</ul>
</p>

<p>
This document explains how to set up a multinode Vespa system on AWS EC2 instances.
The tasks involved are similar to <a href="vespa-quick-start.html">setting up a single-node system</a>.
There is also a guide on <a href="/vespa-quick-start-multinode-aws-ecs.html">using ECS to set up a multinode docker based system</a>.
</p>

<h2 id="launch-instances">Launch instances on <a href="aws.amazon.com/ec2">AWS EC2</a> </h2>
<ol>
	<li><strong>Configure an AWS security group</strong>
	<p>First we'll need to configure an <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-network-security.html">AWS security group</a>
	 which will limit access to the installation and allow our launced EC2 instances to talk to each other without restrictions. 
         See <a href="securing-your-vespa-installation.html">more about securing Vespa installations</a>.</p> 
	 <ul>
	<li><p>Allow access to inbound TCP port 8080 (feed & search interface) from your source IP range</p> </li>
	<li><p>Allow access tp inbound for all TCP traffic on port range 0 - 65535 for members of the security group. 
	This is done by first creating the security group with basic access from your source IP range to port 8080 for search and feed then once saved edit it with an 
	additional inbound rule which uses the security group name as source</p>
	</li>
	</ul>
	</li>
	<li><strong>Chose Amazon Machine image (AMI) </strong>:
	<p>Chose Linux/Unix, CentOS 7 | 64-bit Amazon Machine Image (AMI) as Amazon Machine Image (AMI) when launching your new instances. There are both commercial AMI's and Community based AMI's available.</p>
	</li>
	<li><strong>Chose instance type and launch 4 instances</strong></li>
	<p>For getting through this start guide the <i>t2.medium</i> will do the job. 
        For production setups see our <a href="performance/sizing-search.html">sizing guide</a>.</p> 
	</li>
</ol>


<h2 id="install-vespa">Install and run Vespa</h2>

<p> Create a hostfile listing the hosts in the system
(<em>vespa-instances.txt</em>) to simplify the process multinode
install process.
</p>
<pre class="brush: cli">
$ cat vespa-instances.txt
ip-172-1-1-1.us-east-2.compute.internal
ip-172-1-1-2.us-east-2.compute.internal
ip-172-1-1-3.us-east-2.compute.internal
ip-172-1-1-4.us-east-2.compute.internal
</pre>
<p>
In this example we'll use the <em>ip-172-1-1-1.us-east-2.compute.internal</em> 
instance as our administration node and all commands below are run from that node.</p>
<ol>
<li><p><strong>Install Vespa on all instances:</strong></p>
<p>First log on to the adminstration instance using the Public DNS record name, e.g <em>ec2-18-1-1-1.us-east-2.compute.amazonaws.com</em> using your aws identify <em> ssh -i</em>, then install vespa on all instances by:</p>
<pre>
[centos@ip-172-1-1-1 ~]$  for i in $(cat vespa-instances.txt); do \
	 ssh -i my-aws.key centos@$i sudo yum -y install yum-utils epel-release;\
  done
[centos@ip-172-1-1-1 ~]$ for i in $(cat vespa-instances.txt); do \
	ssh -i my-aws.key centos@$i sudo yum-config-manager --add-repo https://copr.fedorainfracloud.org/coprs/g/vespa/vespa/repo/epel-7/group_vespa-vespa-epel-7.repo;\
  done
[centos@ip-172-1-1-1 ~]$ for i in $(cat vespa-instances.txt); do \
	sudo yum -y install vespaÂ \
  done
</pre>
</li>

<li><p><strong>Set the environment variable VESPA_HOME and update PATH:</strong></p>
<pre>[centos@ip-172-1-1-1 ~]$ export VESPA_HOME=/opt/vespa; export PATH=$PATH:/opt/vespa/bin</pre></li>

<li><p><strong>Set the Vespa config server(s) address:</strong>
This must be a fully qualified hostname, add the following to the <a href="setting-vespa-variables">default Vespa environment variables file</a>:  
<pre>
[centos@ip-172-1-1-1 ~]$ sudo echo "override VESPA_CONFIGSERVERS ip-172-1-1-1.us-east-2.compute.internal" >> $VESPA_HOME/conf/vespa/default-env.txt
[centos@ip-172-1-1-1 ~]$ for i in $(cat vespa-instances.txt); do \
        scp -i my-aws.key $VESPA_HOME/conf/vespa/default-env.txt centos@$i:tmp.env.txt; \
  done

[centos@ip-172-1-1-1 ~]$ for i in $(cat vespa-instances.txt); do \
	ssh -i my-aws.key centos@$i mv tmp.env.txt $VESPA_HOME/conf/vespa/default-env.txt;\
  done
</pre>
<p>
Vespa requires that the <em>'hostname'</em> command returns the exact same name as registered in DNS, e.g by <em>nslookup $(hostname) |grep Name</em>.
If it does not match you can update it on CentOs 7 by running : </p>
<pre>
[centos@ip-172-1-1-1 ~]$ for i in $(cat vespa-instances.txt); do \
	ssh -i my-aws.key centos@$i sudo hostnamectl set-hostname $i;\
  done
</pre>

<li><p><strong>Start the Vespa config server:</strong>
Start the Vespa config server on the designated admin host.
It needs to be up and running
before deploying your application (wait five seconds after start, then proceed to next step):</p>
<pre>
[centos@ip-172-1-1-1 ~]$ sudo service vespa-configserver start
</pre>
<p>Note that the configuration server only needs to be started on the instance(s) which matches the VESPA_CONFIGSERVER env variable</p>
</li>
Note that for production you can set up a cluster of administration hosts.

<li><p><strong>Start Vespa service on all nodes:</strong></p>
<pre>
[centos@ip-172-1-1-1 ~]$  for i in $(cat vespa-instances.txt); do \
	ssh -i my-aws.key centos@$i   sudo service vespa start; \
  done
</pre>
</li>
</ol>

<h2 id="configure-vespa">Configure and deploy your Vespa application</h2>
<ol>

<li><p><strong>Configure the multi-node application:</strong> An example application is found at
<a href="https://github.com/vespa-engine/sample-apps/tree/master/basic-search">github.com/vespa-engine/sample-apps/basic-search</a>.
Install git and clone a copy:</p>
<pre>
[centos@ip-172-1-1-1 ~]$ sudo yum -y install git 
[centos@ip-172-1-1-1 ~]$ git clone https://github.com/vespa-engine/sample-apps.git 
[centos@ip-172-1-1-1 ~]$ cd sample-apps/basic-search
</pre>
Modify <em>src/main/application/hosts.xml</em> so the resulting file looks like:
<pre>
&lt;?xml version="1.0" encoding="utf-8" ?&gt;
&lt;!-- Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root. --&gt;
&lt;hosts&gt;
  &lt;host name="ip-172-1-1-1.us-east-2.compute.internal"&gt;
    &lt;alias&gt;admin0&lt;/alias&gt;
    &lt;alias&gt;stateless0&lt;/alias&gt;
  &lt;/host&gt;

  &lt;host name="ip-172-1-1-2.us-east-2.compute.internal"&gt;
    &lt;alias&gt;stateless1&lt;/alias&gt;
  &lt;/host&gt;

  &lt;host name="ip-172-1-1-3.us-east-2.compute.internal"&gt;
    &lt;alias&gt;content0&lt;/alias&gt;
  &lt;/host&gt;

  &lt;host name="ip-172-1-1-4.us-east-2.compute.internal"&gt;
    &lt;alias&gt;content1&lt;/alias&gt;
  &lt;/host&gt;
&lt;/hosts&gt;
</pre>

Now modify the <em>src/main/application/services.xml</em> to:
<pre>
&lt;?xml version="1.0" encoding="utf-8" ?&gt;
&lt;!-- Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root. --&gt;
&lt;services version="1.0"&gt;
  &lt;admin version="2.0"&gt;
    &lt;adminserver hostalias="admin0"/&gt;
    &lt;configservers&gt;
      &lt;configserver hostalias="admin0"/&gt;
    &lt;/configservers&gt;
  &lt;/admin&gt;

  &lt;container version="1.0" id="default"&gt;
    &lt;document-api/&gt;
    &lt;search/&gt;
    &lt;nodes&gt;
      &lt;node hostalias="stateless0"/&gt;
      &lt;node hostalias="stateless1"/&gt;
    &lt;/nodes&gt;
  &lt;/container&gt;

  &lt;content id="music" version="1.0"&gt;
    &lt;redundancy&gt;2&lt;/redundancy&gt;
    &lt;documents&gt;
      &lt;document type="music" mode="index"/&gt;
    &lt;/documents&gt;
    &lt;nodes&gt;
      &lt;node hostalias="content0" distribution-key="0"/&gt;
      &lt;node hostalias="content1" distribution-key="1"/&gt;
    &lt;/nodes&gt;
  &lt;/content&gt;
&lt;/services&gt;
</pre>
</li>

<li><p><strong>Deploy the application :</strong></p>
<pre>
[centos@ip-172-1-1-1 ~]$ vespa-deploy prepare src/main/application && vespa-deploy activate 
</pre>
<p>Our instances running vespa will subscribe to configuration and once the applicaiton is 
deployed the set of services configured will start, no need to re-start vespa or the configuration server</p>
</li>
When you change your application just deploy again and the system will make the change.

<li><p><strong>Feed documents :</strong> Feed sample documents:
<pre>
[centos@ip-172-1-1-1 ~]$ java -jar $VESPA_HOME/lib/jars/vespa-http-client-jar-with-dependencies.jar \
  --file music-data-feed.json --host localhost --port 8080
</pre>
</li>

<li><p><strong>Run a query against the containers</strong></p>
<pre>
$ curl -s http://ip-172-1-1-1.us-east-2.compute.internal:8080/search/?query=bad | python -m json.tool
$ curl -s http://ip-172-1-1-2.us-east-2.compute.internal:8080/search/?query=bad | python -m json.tool
</pre>
<p>
  Read more in the
  <a href="search-api.html">Search API</a></p>
</li>
<li><strong>Configure AWS EC2 Load Balancer (Optional) </strong>
<p> 
 Once setup is complete you can configure a load balancer using the same security group which forwards 
 requests to our two serving containers listening on 
 port 8080 mentioned above, using </em>/status.html</em> as health check. You can then access both endpoints 
 through a DNS A record, e.g <em>vespa-multinode-12345678910.us-east-2.elb.amazonaws.com:8080</em>. </p>

</li>
</ol>



<h2 id="next-steps">Next Steps</h2>
<ul>
  <li>
    Try the <a href="tutorials/blog-search.html">Blog search and recommendation tutorial</a>
    to learn more about using Vespa
  </li><li>
    See <a href="jdisc/developing-applications.html">developing applications</a>
    on adding your own Java components to your Vespa application.
  </li><li>
    <a href="api.html">Vespa APIs</a> is useful to understand how to interface with Vespa
  </li><li>
    Explore the <a href="https://github.com/vespa-engine/sample-apps/tree/master">
      sample applications</a>
  </li><li>
    How to <a href="securing-your-vespa-installation.html">secure a Vespa installation</a>
  </li>
</ul>


